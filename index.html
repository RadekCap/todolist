<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoList</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            --primary-start: #b8c5f2;
            --primary-end: #c5b3d9;
            --accent-color: #b8c5f2;
            --accent-hover: #a0aee6;
        }

        /* Purple Theme (Default) */
        [data-theme="purple"] {
            --primary-start: #b8c5f2;
            --primary-end: #c5b3d9;
            --accent-color: #b8c5f2;
            --accent-hover: #a0aee6;
        }

        /* Blue Theme */
        [data-theme="blue"] {
            --primary-start: #a8d5f7;
            --primary-end: #b3e5fc;
            --accent-color: #a8d5f7;
            --accent-hover: #8fc3e8;
        }

        /* Green Theme */
        [data-theme="green"] {
            --primary-start: #a8e6c1;
            --primary-end: #b8f0da;
            --accent-color: #a8e6c1;
            --accent-hover: #8ed4a8;
        }

        /* Orange Theme */
        [data-theme="orange"] {
            --primary-start: #fcc5d3;
            --primary-end: #fff0b8;
            --accent-color: #fcc5d3;
            --accent-hover: #f5a9bc;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --primary-start: #546e7a;
            --primary-end: #607d8b;
            --accent-color: #81b3d2;
            --accent-hover: #6a9fc4;
        }

        /* Light Theme */
        [data-theme="light"] {
            --primary-start: #d4f5f3;
            --primary-end: #fef0f5;
            --accent-color: #d4f5f3;
            --accent-hover: #b8e3e0;
        }

        /* Glass Theme - iOS 26 Style */
        [data-theme="glass"] {
            /* iOS System Background Colors */
            --ios-bg-primary: #f2f2f7;
            --ios-bg-secondary: #ffffff;
            --ios-bg-tertiary: #f2f2f7;
            --ios-bg-grouped: #f2f2f7;

            /* iOS System Colors */
            --ios-blue: #007aff;
            --ios-blue-hover: #0056b3;
            --ios-gray: #8e8e93;
            --ios-gray2: #aeaeb2;
            --ios-gray3: #c7c7cc;
            --ios-gray4: #d1d1d6;
            --ios-gray5: #e5e5ea;
            --ios-gray6: #f2f2f7;
            --ios-red: #ff3b30;
            --ios-orange: #ff9500;

            /* iOS Label Colors */
            --ios-label: #000000;
            --ios-label-secondary: #3c3c43;
            --ios-label-tertiary: #3c3c4399;
            --ios-label-quaternary: #3c3c434d;

            /* iOS Material - Thick */
            --ios-material-thick: rgba(255, 255, 255, 0.92);
            --ios-material-regular: rgba(255, 255, 255, 0.85);
            --ios-material-thin: rgba(255, 255, 255, 0.75);
            --ios-material-ultrathin: rgba(255, 255, 255, 0.55);

            /* iOS Blur */
            --ios-blur-thick: 50px;
            --ios-blur-regular: 40px;
            --ios-blur-thin: 30px;

            /* iOS Separator */
            --ios-separator: rgba(60, 60, 67, 0.12);
            --ios-separator-opaque: #c6c6c8;

            /* Theme mapping */
            --primary-start: #e8eaed;
            --primary-end: #f5f5f7;
            --accent-color: var(--ios-blue);
            --accent-hover: var(--ios-blue-hover);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-in-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 15px;
            color: #666;
            font-weight: 500;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Container states */
        .container.loading {
            visibility: hidden;
        }

        .container.loaded {
            visibility: visible;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1100px;
            padding: 30px;
        }

        .container.auth-mode {
            max-width: 500px;
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2em;
        }

        .auth-container {
            display: none;
        }

        .auth-container.active {
            display: block;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-display {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .user-email {
            color: #999;
            font-size: 12px;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            padding: 8px 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .settings-btn:hover {
            background: var(--accent-hover);
        }

        .logout-btn {
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .lock-btn {
            padding: 8px 12px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .lock-btn:hover {
            background: #d68910;
        }

        .app-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .app-version {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .theme-selector {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 13px;
        }

        .theme-selector label {
            color: #666;
            font-weight: 500;
        }

        .theme-selector select {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            transition: border-color 0.3s;
        }

        .theme-selector select:hover {
            border-color: #ccc;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .app-footer-links {
            font-size: 11px;
            color: #aaa;
        }

        .app-footer-links a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .app-footer-links a:not(:last-child)::after {
            content: " ‚Ä¢ ";
            color: #aaa;
            margin: 0 8px;
        }

        .app-footer-links a:hover {
            text-decoration: underline;
        }

        .app-footer-links a:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 200px;
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            padding: 10px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }

        .category-item:hover {
            background: #f8f9fa;
        }

        .category-item.active {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            font-weight: 600;
        }

        .category-name {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .category-delete {
            opacity: 0;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 16px;
            transition: opacity 0.2s;
        }

        .category-item:hover .category-delete {
            opacity: 0.7;
        }

        .category-delete:hover {
            opacity: 1 !important;
        }

        .add-category-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .add-category-input {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .add-category-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .add-category-btn {
            width: 100%;
            padding: 8px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-category-btn:hover {
            background: var(--accent-hover);
        }

        .add-category-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            flex: 1;
            min-width: 0;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            gap: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        #todoInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #todoInput:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #categorySelect {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            background: white;
            min-width: 150px;
        }

        #categorySelect:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #dueDateInput {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            background: white;
            min-width: 150px;
        }

        #dueDateInput:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #addBtn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        #addBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #addBtn:active {
            transform: translateY(0);
        }

        #addBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .todo-list {
            list-style: none;
        }

        .todo-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid transparent;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .todo-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .todo-item[draggable="true"] {
            cursor: grab;
        }

        /* Drop target styles */
        .category-item.drag-over,
        .context-item.drag-over,
        .gtd-tab.drag-over {
            background: var(--accent-color) !important;
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .todo-text {
            flex: 1;
            color: #333;
            font-size: 16px;
            word-break: break-word;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #999;
        }

        .todo-category-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }

        .todo-date {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            background: #f0f0f0;
            white-space: nowrap;
        }

        .todo-date.overdue {
            background: #fee;
            color: #c33;
        }

        .todo-date.today {
            background: #fff3cd;
            color: #856404;
        }

        .todo-priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }

        .edit-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .edit-btn:hover {
            background: var(--accent-hover);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 16px;
        }

        .loading-state {
            text-align: center;
            color: var(--accent-color);
            padding: 40px 20px;
            font-size: 16px;
        }

        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 14px;
        }

        .add-todo-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .add-todo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: background 0.2s, color 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-form label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modal-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal-btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .input-row {
                flex-direction: column;
            }

            #categorySelect {
                min-width: auto;
            }

            .user-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .user-info {
                flex-wrap: wrap;
                min-width: 0;
            }

            .user-email {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 150px;
            }

            .user-actions {
                flex-shrink: 0;
            }
        }

        /* ========================================
           GTD Tabs and Context Styles
           ======================================== */

        .gtd-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            padding: 4px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow-x: auto;
        }

        .gtd-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .gtd-tab:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }

        .gtd-tab.active {
            background: white;
            color: #333;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Contexts section in sidebar */
        .contexts-header {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .context-list {
            list-style: none;
        }

        .context-item {
            padding: 10px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }

        .context-item:hover {
            background: #f8f9fa;
        }

        .context-item.active {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            font-weight: 600;
        }

        .context-name {
            flex: 1;
        }

        .context-delete {
            opacity: 0;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 16px;
            transition: opacity 0.2s;
        }

        .context-item:hover .context-delete {
            opacity: 0.7;
        }

        .context-delete:hover {
            opacity: 1 !important;
        }

        .add-context-form {
            margin-top: 15px;
        }

        .add-context-input {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .add-context-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .add-context-btn {
            width: 100%;
            padding: 8px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-context-btn:hover {
            background: var(--accent-hover);
        }

        .add-context-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* GTD Status Badge Colors */
        .todo-gtd-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .todo-gtd-badge.inbox {
            background: #e3f2fd;
            color: #1976d2;
        }

        .todo-gtd-badge.next_action {
            background: #e8f5e9;
            color: #388e3c;
        }

        .todo-gtd-badge.waiting_for {
            background: #fff3e0;
            color: #f57c00;
        }

        .todo-gtd-badge.someday_maybe {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Context Badge */
        .todo-context-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #eceff1;
            color: #546e7a;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .gtd-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .gtd-tab {
                flex: 0 0 auto;
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* ========================================
           Glass Theme - iOS 26 Authentic Design
           ======================================== */

        /* iOS Background - Subtle light gradient */
        [data-theme="glass"] body {
            background: var(--ios-bg-grouped);
            background-image: linear-gradient(180deg, #ffffff 0%, var(--ios-gray6) 100%);
            background-attachment: fixed;
        }

        /* iOS Container - Thick material */
        [data-theme="glass"] .container {
            background: var(--ios-material-thick);
            backdrop-filter: blur(var(--ios-blur-thick));
            -webkit-backdrop-filter: blur(var(--ios-blur-thick));
            border: none;
            box-shadow: 0 0 0 0.5px var(--ios-separator-opaque),
                        0 2px 10px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
        }

        /* iOS Typography */
        [data-theme="glass"] h1 {
            color: var(--ios-label);
            font-weight: 700;
            font-size: 28px;
            letter-spacing: -0.5px;
        }

        [data-theme="glass"] h2 {
            color: var(--ios-label-secondary);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* iOS Segmented Control (Auth tabs) */
        [data-theme="glass"] .auth-tabs {
            background: var(--ios-gray5);
            border-radius: 9px;
            padding: 2px;
        }

        [data-theme="glass"] .auth-tab {
            background: transparent;
            border: none;
            border-radius: 7px;
            color: var(--ios-label);
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        [data-theme="glass"] .auth-tab:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        [data-theme="glass"] .auth-tab.active {
            background: var(--ios-bg-secondary);
            color: var(--ios-label);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08),
                        0 0 0 0.5px var(--ios-separator);
        }

        /* iOS Form Inputs */
        [data-theme="glass"] .form-group input,
        [data-theme="glass"] .form-group select,
        [data-theme="glass"] .modal-form input,
        [data-theme="glass"] .modal-form select {
            background: var(--ios-bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--ios-label);
            font-size: 17px;
            padding: 11px 16px;
            box-shadow: inset 0 0 0 0.5px var(--ios-separator);
            transition: box-shadow 0.2s ease;
        }

        [data-theme="glass"] .form-group input:focus,
        [data-theme="glass"] .form-group select:focus,
        [data-theme="glass"] .modal-form input:focus,
        [data-theme="glass"] .modal-form select:focus {
            background: var(--ios-bg-secondary);
            box-shadow: inset 0 0 0 0.5px var(--ios-separator),
                        0 0 0 4px rgba(0, 122, 255, 0.15);
            outline: none;
        }

        [data-theme="glass"] .form-group input::placeholder,
        [data-theme="glass"] .modal-form input::placeholder {
            color: var(--ios-label-tertiary);
        }

        [data-theme="glass"] .form-group label,
        [data-theme="glass"] .modal-form label {
            color: var(--ios-label);
            font-weight: 400;
            font-size: 15px;
        }

        /* iOS Buttons - Filled style */
        [data-theme="glass"] .auth-btn,
        [data-theme="glass"] .modal-btn-primary,
        [data-theme="glass"] .add-todo-btn {
            background: var(--ios-blue);
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 17px;
            padding: 14px 20px;
            box-shadow: none;
            transition: all 0.15s ease;
        }

        [data-theme="glass"] .auth-btn:hover,
        [data-theme="glass"] .modal-btn-primary:hover,
        [data-theme="glass"] .add-todo-btn:hover {
            background: var(--ios-blue-hover);
            transform: none;
            box-shadow: none;
        }

        [data-theme="glass"] .auth-btn:active,
        [data-theme="glass"] .modal-btn-primary:active,
        [data-theme="glass"] .add-todo-btn:active {
            transform: scale(0.98);
        }

        [data-theme="glass"] .modal-btn-secondary {
            background: var(--ios-gray5);
            color: var(--ios-label);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 17px;
        }

        [data-theme="glass"] .modal-btn-secondary:hover {
            background: var(--ios-gray4);
        }

        /* iOS Sidebar */
        [data-theme="glass"] .sidebar {
            background: transparent;
        }

        [data-theme="glass"] .sidebar h2 {
            color: var(--ios-label-secondary);
            padding-left: 16px;
            margin-bottom: 8px;
        }

        /* iOS Grouped List (Categories) */
        [data-theme="glass"] .category-list {
            background: var(--ios-bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 0 0.5px var(--ios-separator);
        }

        [data-theme="glass"] .category-item {
            background: transparent;
            border: none;
            border-radius: 0;
            color: var(--ios-label);
            padding: 12px 16px;
            margin-bottom: 0;
            transition: background 0.15s ease;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        [data-theme="glass"] .category-item:last-child {
            border-bottom: none;
        }

        [data-theme="glass"] .category-item:hover {
            background: var(--ios-gray6);
        }

        [data-theme="glass"] .category-item.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            box-shadow: none;
        }

        [data-theme="glass"] .category-item.active .category-name {
            font-weight: 600;
        }

        [data-theme="glass"] .add-category-form {
            border-top: none;
            padding-top: 20px;
        }

        [data-theme="glass"] .add-category-input {
            background: var(--ios-bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--ios-label);
            font-size: 15px;
            box-shadow: inset 0 0 0 0.5px var(--ios-separator);
        }

        [data-theme="glass"] .add-category-input:focus {
            background: var(--ios-bg-secondary);
            box-shadow: inset 0 0 0 0.5px var(--ios-separator),
                        0 0 0 4px rgba(0, 122, 255, 0.15);
        }

        [data-theme="glass"] .add-category-btn {
            background: var(--ios-blue);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            transition: background 0.15s ease;
        }

        [data-theme="glass"] .add-category-btn:hover {
            background: var(--ios-blue-hover);
        }

        /* iOS Todo Items - Grouped list style */
        [data-theme="glass"] .todo-list {
            background: var(--ios-bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 0 0.5px var(--ios-separator);
        }

        [data-theme="glass"] .todo-item {
            background: transparent;
            border: none;
            border-left: none;
            border-radius: 0;
            margin-bottom: 0;
            padding: 14px 16px;
            border-bottom: 0.5px solid var(--ios-separator);
            transition: background 0.15s ease;
        }

        [data-theme="glass"] .todo-item:last-child {
            border-bottom: none;
        }

        [data-theme="glass"] .todo-item:hover {
            background: var(--ios-gray6);
            transform: none;
            box-shadow: none;
        }

        [data-theme="glass"] .todo-item.completed {
            opacity: 0.5;
        }

        [data-theme="glass"] .todo-text {
            color: var(--ios-label);
            font-size: 17px;
        }

        [data-theme="glass"] .todo-item.completed .todo-text {
            color: var(--ios-label-tertiary);
        }

        [data-theme="glass"] .todo-checkbox {
            width: 22px;
            height: 22px;
            accent-color: var(--ios-blue);
        }

        [data-theme="glass"] .edit-btn {
            background: var(--ios-blue);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            padding: 6px 12px;
            font-weight: 500;
        }

        [data-theme="glass"] .edit-btn:hover {
            background: var(--ios-blue-hover);
        }

        [data-theme="glass"] .delete-btn {
            background: var(--ios-red);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            padding: 6px 12px;
            font-weight: 500;
        }

        [data-theme="glass"] .delete-btn:hover {
            background: #e62e24;
        }

        /* iOS Badges */
        [data-theme="glass"] .todo-category-badge,
        [data-theme="glass"] .todo-priority-badge {
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            padding: 3px 8px;
        }

        [data-theme="glass"] .todo-date {
            background: var(--ios-gray5);
            color: var(--ios-label-secondary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            padding: 3px 8px;
        }

        [data-theme="glass"] .todo-date.overdue {
            background: rgba(255, 59, 48, 0.15);
            color: var(--ios-red);
        }

        [data-theme="glass"] .todo-date.today {
            background: rgba(255, 149, 0, 0.15);
            color: var(--ios-orange);
        }

        /* iOS Stats */
        [data-theme="glass"] .stats {
            color: var(--ios-label-secondary);
            border-top-color: var(--ios-separator);
            font-size: 13px;
        }

        /* iOS User Header */
        [data-theme="glass"] .user-header {
            border-top-color: var(--ios-separator);
        }

        [data-theme="glass"] .user-display {
            color: var(--ios-label);
            font-weight: 600;
        }

        [data-theme="glass"] .user-email {
            color: var(--ios-label-tertiary);
        }

        [data-theme="glass"] .settings-btn {
            background: var(--ios-gray5);
            color: var(--ios-label);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.15s ease;
        }

        [data-theme="glass"] .settings-btn:hover {
            background: var(--ios-gray4);
        }

        [data-theme="glass"] .lock-btn {
            background: var(--ios-orange);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            transition: background 0.15s ease;
        }

        [data-theme="glass"] .lock-btn:hover {
            background: #e68600;
        }

        [data-theme="glass"] .logout-btn {
            background: var(--ios-red);
            border: none;
            border-radius: 8px;
            transition: background 0.15s ease;
        }

        [data-theme="glass"] .logout-btn:hover {
            background: #e62e24;
        }

        /* iOS Footer */
        [data-theme="glass"] .app-footer {
            border-top-color: var(--ios-separator);
        }

        [data-theme="glass"] .app-version {
            color: var(--ios-label-tertiary);
        }

        [data-theme="glass"] .theme-selector label {
            color: var(--ios-label-secondary);
        }

        [data-theme="glass"] .theme-selector select {
            background: var(--ios-bg-secondary);
            border: none;
            border-radius: 8px;
            color: var(--ios-label);
            box-shadow: 0 0 0 0.5px var(--ios-separator);
            padding: 8px 12px;
        }

        [data-theme="glass"] .app-footer-links a {
            color: var(--ios-blue);
        }

        [data-theme="glass"] .app-footer-links a:hover {
            color: var(--ios-blue-hover);
        }

        /* iOS Modal Overlay */
        [data-theme="glass"] .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(var(--ios-blur-thin));
            -webkit-backdrop-filter: blur(var(--ios-blur-thin));
        }

        /* iOS Modal - Sheet style */
        [data-theme="glass"] .modal {
            background: var(--ios-bg-grouped);
            backdrop-filter: blur(var(--ios-blur-thick));
            -webkit-backdrop-filter: blur(var(--ios-blur-thick));
            border: none;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.35);
            border-radius: 14px;
        }

        [data-theme="glass"] .modal-header {
            border-bottom: 0.5px solid var(--ios-separator);
            padding-bottom: 15px;
        }

        [data-theme="glass"] .modal-header h2 {
            color: var(--ios-label);
            font-size: 17px;
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0;
        }

        [data-theme="glass"] .modal-close {
            color: var(--ios-gray);
            background: var(--ios-gray5);
            width: 30px;
            height: 30px;
            border-radius: 15px;
            font-size: 20px;
        }

        [data-theme="glass"] .modal-close:hover {
            background: var(--ios-gray4);
            color: var(--ios-label);
        }

        /* iOS Empty State */
        [data-theme="glass"] .empty-state {
            color: var(--ios-label-tertiary);
            font-size: 15px;
        }

        /* iOS Messages */
        [data-theme="glass"] .error-message {
            background: rgba(255, 59, 48, 0.12);
            color: var(--ios-red);
            border: none;
            border-radius: 10px;
            font-size: 14px;
        }

        [data-theme="glass"] .success-message {
            background: rgba(52, 199, 89, 0.12);
            color: #34c759;
            border: none;
            border-radius: 10px;
            font-size: 14px;
        }

        /* iOS Category Colors */
        [data-theme="glass"] .category-color {
            width: 10px;
            height: 10px;
        }

        /* ========================================
           Glass Theme - GTD Elements
           ======================================== */

        /* iOS Segmented Control style for GTD tabs */
        [data-theme="glass"] .gtd-tabs {
            background: var(--ios-gray5);
            border-radius: 9px;
            padding: 2px;
        }

        [data-theme="glass"] .gtd-tab {
            background: transparent;
            color: var(--ios-label);
            font-weight: 500;
            font-size: 13px;
            border-radius: 7px;
            transition: all 0.2s ease;
        }

        [data-theme="glass"] .gtd-tab:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        [data-theme="glass"] .gtd-tab.active {
            background: var(--ios-bg-secondary);
            color: var(--ios-label);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08),
                        0 0 0 0.5px var(--ios-separator);
        }

        /* iOS Contexts Section */
        [data-theme="glass"] .contexts-header {
            color: var(--ios-label-secondary);
            border-top-color: var(--ios-separator);
        }

        [data-theme="glass"] .context-list {
            background: var(--ios-bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 0 0.5px var(--ios-separator);
        }

        [data-theme="glass"] .context-item {
            background: transparent;
            border: none;
            border-radius: 0;
            color: var(--ios-label);
            padding: 12px 16px;
            margin-bottom: 0;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        [data-theme="glass"] .context-item:last-child {
            border-bottom: none;
        }

        [data-theme="glass"] .context-item:hover {
            background: var(--ios-gray6);
        }

        [data-theme="glass"] .context-item.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
        }

        /* Glass theme drag-over states */
        [data-theme="glass"] .category-item.drag-over,
        [data-theme="glass"] .context-item.drag-over,
        [data-theme="glass"] .gtd-tab.drag-over {
            background: var(--ios-blue) !important;
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        [data-theme="glass"] .add-context-input {
            background: var(--ios-bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--ios-label);
            font-size: 15px;
            box-shadow: inset 0 0 0 0.5px var(--ios-separator);
        }

        [data-theme="glass"] .add-context-input:focus {
            box-shadow: inset 0 0 0 0.5px var(--ios-separator),
                        0 0 0 4px rgba(0, 122, 255, 0.15);
        }

        [data-theme="glass"] .add-context-btn {
            background: var(--ios-blue);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        [data-theme="glass"] .add-context-btn:hover {
            background: var(--ios-blue-hover);
        }

        /* iOS GTD Badges */
        [data-theme="glass"] .todo-gtd-badge {
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            padding: 3px 8px;
        }

        [data-theme="glass"] .todo-gtd-badge.inbox {
            background: rgba(0, 122, 255, 0.15);
            color: var(--ios-blue);
        }

        [data-theme="glass"] .todo-gtd-badge.next_action {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }

        [data-theme="glass"] .todo-gtd-badge.waiting_for {
            background: rgba(255, 149, 0, 0.15);
            color: var(--ios-orange);
        }

        [data-theme="glass"] .todo-gtd-badge.someday_maybe {
            background: rgba(175, 82, 222, 0.15);
            color: #af52de;
        }

        /* iOS Context Badge */
        [data-theme="glass"] .todo-context-badge {
            background: var(--ios-gray5);
            color: var(--ios-label-secondary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            padding: 3px 8px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <div class="container auth-mode loading" id="mainContainer">
        <h1>üìù TodoList</h1>

        <!-- Authentication UI -->
        <div id="authContainer" class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
            </div>

            <div id="authMessage"></div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="auth-btn">Login</button>
            </form>

            <!-- Signup Form -->
            <form id="signupForm" class="auth-form">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required autocomplete="new-password" minlength="6">
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" required autocomplete="new-password" minlength="6">
                </div>
                <button type="submit" class="auth-btn">Sign Up</button>
            </form>
        </div>

        <!-- App UI (shown after login) -->
        <div id="appContainer" class="app-container">
            <div class="main-content">
                <!-- Sidebar with categories -->
                <div class="sidebar">
                    <h2>Categories</h2>
                    <ul id="categoryList" class="category-list"></ul>
                    <div class="add-category-form">
                        <input
                            type="text"
                            id="newCategoryInput"
                            class="add-category-input"
                            placeholder="New category..."
                            autocomplete="off"
                        >
                        <button id="addCategoryBtn" class="add-category-btn">Add Category</button>
                    </div>

                    <h2 class="contexts-header">Contexts</h2>
                    <ul id="contextList" class="context-list"></ul>
                    <div class="add-context-form">
                        <input
                            type="text"
                            id="newContextInput"
                            class="add-context-input"
                            placeholder="@context..."
                            autocomplete="off"
                        >
                        <button id="addContextBtn" class="add-context-btn">Add Context</button>
                    </div>
                </div>

                <!-- Main content area -->
                <div class="content">
                    <button id="openAddTodoModal" class="add-todo-btn">+ Add New Todo</button>

                    <!-- GTD Status Tabs -->
                    <div class="gtd-tabs" id="gtdTabs" role="tablist" aria-label="GTD Status Filter">
                        <button class="gtd-tab active" data-status="all" role="tab" aria-selected="true">All</button>
                        <button class="gtd-tab" data-status="inbox" role="tab" aria-selected="false">Inbox</button>
                        <button class="gtd-tab" data-status="next_action" role="tab" aria-selected="false">Next</button>
                        <button class="gtd-tab" data-status="waiting_for" role="tab" aria-selected="false">Waiting</button>
                        <button class="gtd-tab" data-status="someday_maybe" role="tab" aria-selected="false">Someday</button>
                    </div>

                    <ul id="todoList" class="todo-list"></ul>

                    <div class="stats">
                        <span id="totalTodos">Total: 0</span>
                        <span id="completedTodos">Completed: 0</span>
                    </div>
                </div>
            </div>

            <div class="user-header">
                <div class="user-info">
                    <span class="user-display" id="userDisplay"></span>
                    <span class="user-email" id="userEmail"></span>
                </div>
                <div class="user-actions">
                    <button id="lockBtn" class="lock-btn" aria-label="Lock application">üîí</button>
                    <button id="settingsBtn" class="settings-btn">Settings</button>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>

            <footer class="app-footer">
                <div class="app-version" id="appVersion">
                    Version <span id="versionNumber">0.0.0</span>
                </div>
                <div class="theme-selector">
                    <label for="themeSelect">Theme:</label>
                    <select id="themeSelect" aria-label="Color scheme selector">
                        <option value="purple">Purple</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="orange">Orange</option>
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="glass">Glass</option>
                    </select>
                </div>
                <div class="app-footer-links">
                    <a href="https://github.com/RadekCap/todolist" target="_blank" rel="noopener noreferrer">GitHub</a>
                    <a href="https://github.com/RadekCap/todolist/blob/main/VERSION.md" target="_blank" rel="noopener noreferrer">Changelog</a>
                    <a href="https://github.com/RadekCap/todolist/issues/new?labels=feature-request" target="_blank" rel="noopener noreferrer">Request Feature</a>
                    <a href="https://github.com/RadekCap/todolist/issues/new?labels=bug" target="_blank" rel="noopener noreferrer">Report Issue</a>
                </div>
            </footer>
        </div>

        <!-- Add Todo Modal -->
        <div id="addTodoModal" class="modal-overlay">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <div class="modal-header">
                    <h2 id="modalTitle">Add New Todo</h2>
                    <button id="closeModal" class="modal-close" aria-label="Close modal">&times;</button>
                </div>
                <form id="addTodoForm" class="modal-form">
                    <div>
                        <label for="modalTodoInput">What needs to be done?</label>
                        <input
                            type="text"
                            id="modalTodoInput"
                            placeholder="Enter todo description..."
                            autocomplete="off"
                            required
                        >
                    </div>
                    <div>
                        <label for="modalCategorySelect">Category (optional)</label>
                        <select id="modalCategorySelect">
                            <option value="">No Category</option>
                        </select>
                    </div>
                    <div>
                        <label for="modalPrioritySelect">Priority (optional)</label>
                        <select id="modalPrioritySelect" aria-label="Priority (optional)">
                            <option value="">No Priority</option>
                        </select>
                    </div>
                    <div>
                        <label for="modalGtdStatusSelect">GTD Status</label>
                        <select id="modalGtdStatusSelect" aria-label="GTD Status">
                            <option value="inbox">Inbox</option>
                            <option value="next_action">Next Action</option>
                            <option value="waiting_for">Waiting For</option>
                            <option value="someday_maybe">Someday/Maybe</option>
                        </select>
                    </div>
                    <div>
                        <label for="modalContextSelect">Context (optional)</label>
                        <select id="modalContextSelect" aria-label="Context (optional)">
                            <option value="">No Context</option>
                        </select>
                    </div>
                    <div>
                        <label for="modalDueDateInput">Due Date (optional)</label>
                        <input
                            type="date"
                            id="modalDueDateInput"
                        >
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="cancelModal" class="modal-btn modal-btn-secondary">Cancel</button>
                        <button type="submit" id="modalAddBtn" class="modal-btn modal-btn-primary">Add Todo</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-overlay">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
                <div class="modal-header">
                    <h2 id="settingsModalTitle">User Settings</h2>
                    <button id="closeSettingsModal" class="modal-close" aria-label="Close modal">&times;</button>
                </div>
                <form id="settingsForm" class="modal-form">
                    <div>
                        <label for="usernameInput">Display Name</label>
                        <input
                            type="text"
                            id="usernameInput"
                            placeholder="Enter your display name..."
                            autocomplete="off"
                            maxlength="50"
                        >
                        <small style="color: #999; font-size: 12px; display: block; margin-top: 5px;">
                            This name will be displayed instead of your email. Leave empty to show email.
                        </small>
                    </div>
                    <div style="border-top: 1px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                        <label>Data Encryption</label>
                        <p style="color: #666; font-size: 13px; margin: 5px 0 10px 0;">
                            Encrypt any existing unencrypted todos and categories. This is a one-time operation.
                        </p>
                        <button type="button" id="migrateDataBtn" class="modal-btn modal-btn-primary" style="width: 100%;">
                            Encrypt Existing Data
                        </button>
                        <div id="migrateStatus" style="margin-top: 10px; font-size: 13px; display: none;"></div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="cancelSettingsModal" class="modal-btn modal-btn-secondary">Cancel</button>
                        <button type="submit" id="saveSettingsBtn" class="modal-btn modal-btn-primary">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Unlock Modal (for session restore) -->
        <div id="unlockModal" class="modal-overlay">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="unlockModalTitle">
                <div class="modal-header">
                    <h2 id="unlockModalTitle">Unlock Your Data</h2>
                </div>
                <form id="unlockForm" class="modal-form">
                    <div>
                        <p style="color: #666; margin-bottom: 15px;">
                            Enter your password to decrypt your data. Your password is used locally to unlock your encrypted todos and categories.
                        </p>
                        <label for="unlockEmail">Email</label>
                        <input
                            type="email"
                            id="unlockEmail"
                            autocomplete="username email"
                        >
                    </div>
                    <div>
                        <label for="unlockPassword">Password</label>
                        <input
                            type="password"
                            id="unlockPassword"
                            placeholder="Enter your password..."
                            autocomplete="current-password"
                            required
                        >
                    </div>
                    <div id="unlockError" class="error-message" style="display: none;"></div>
                    <div class="modal-actions">
                        <button type="button" id="unlockLogoutBtn" class="modal-btn modal-btn-secondary">Logout</button>
                        <button type="submit" id="unlockBtn" class="modal-btn modal-btn-primary">Unlock</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // Application version - Update when preparing a new release
        const APP_VERSION = '1.0.25'

        // Initialize Supabase
        const supabaseUrl = 'https://rkvmujdayjmszmyzbhal.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrdm11amRheWptc3pteXpiaGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxODc2MDcsImV4cCI6MjA3OTc2MzYwN30.55RoV1mmHeykVz9waU7Jz6-JSkrRqlNa-ABBE8SN-jA'
        const supabase = createClient(supabaseUrl, supabaseKey)

        // Encryption utilities using Web Crypto API
        const CryptoUtils = {
            // Derive an encryption key from password and salt using PBKDF2
            async deriveKey(password, salt) {
                const encoder = new TextEncoder()
                const passwordBuffer = encoder.encode(password)

                // Import password as a key
                const baseKey = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveKey']
                )

                // Derive AES-GCM key using PBKDF2
                return await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    baseKey,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                )
            },

            // Generate a random salt for key derivation
            generateSalt() {
                return crypto.getRandomValues(new Uint8Array(16))
            },

            // Convert Uint8Array to base64 string
            arrayToBase64(array) {
                return btoa(String.fromCharCode(...array))
            },

            // Convert base64 string to Uint8Array
            base64ToArray(base64) {
                const binary = atob(base64)
                const bytes = new Uint8Array(binary.length)
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i)
                }
                return bytes
            },

            // Encrypt plaintext using AES-GCM
            async encrypt(plaintext, key) {
                const encoder = new TextEncoder()
                const data = encoder.encode(plaintext)

                // Generate random IV for each encryption
                const iv = crypto.getRandomValues(new Uint8Array(12))

                const ciphertext = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                )

                // Combine IV + ciphertext and encode as base64
                const combined = new Uint8Array(iv.length + ciphertext.byteLength)
                combined.set(iv)
                combined.set(new Uint8Array(ciphertext), iv.length)

                return this.arrayToBase64(combined)
            },

            // Decrypt ciphertext using AES-GCM
            async decrypt(encryptedBase64, key) {
                const combined = this.base64ToArray(encryptedBase64)

                // Extract IV (first 12 bytes) and ciphertext
                const iv = combined.slice(0, 12)
                const ciphertext = combined.slice(12)

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    ciphertext
                )

                const decoder = new TextDecoder()
                return decoder.decode(decrypted)
            }
        }

        class TodoApp {
            constructor() {
                this.currentUser = null
                this.encryptionKey = null
                this.todos = []
                this.categories = []
                this.priorities = []
                this.contexts = []
                this.selectedCategoryId = null
                this.selectedContextId = null
                this.selectedGtdStatus = 'all'
                this.editingTodoId = null

                // Get DOM elements
                this.loadingScreen = document.getElementById('loadingScreen')
                this.mainContainer = document.getElementById('mainContainer')
                this.authContainer = document.getElementById('authContainer')
                this.appContainer = document.getElementById('appContainer')
                this.authMessage = document.getElementById('authMessage')
                this.loginForm = document.getElementById('loginForm')
                this.signupForm = document.getElementById('signupForm')
                this.userDisplay = document.getElementById('userDisplay')
                this.userEmail = document.getElementById('userEmail')
                this.settingsBtn = document.getElementById('settingsBtn')
                this.lockBtn = document.getElementById('lockBtn')
                this.logoutBtn = document.getElementById('logoutBtn')
                this.settingsModal = document.getElementById('settingsModal')
                this.closeSettingsModalBtn = document.getElementById('closeSettingsModal')
                this.cancelSettingsModalBtn = document.getElementById('cancelSettingsModal')
                this.settingsForm = document.getElementById('settingsForm')
                this.usernameInput = document.getElementById('usernameInput')
                this.saveSettingsBtn = document.getElementById('saveSettingsBtn')
                this.migrateDataBtn = document.getElementById('migrateDataBtn')
                this.migrateStatus = document.getElementById('migrateStatus')
                this.openAddTodoModalBtn = document.getElementById('openAddTodoModal')
                this.addTodoModal = document.getElementById('addTodoModal')
                this.closeModalBtn = document.getElementById('closeModal')
                this.cancelModalBtn = document.getElementById('cancelModal')
                this.addTodoForm = document.getElementById('addTodoForm')
                this.modalTodoInput = document.getElementById('modalTodoInput')
                this.modalCategorySelect = document.getElementById('modalCategorySelect')
                this.modalPrioritySelect = document.getElementById('modalPrioritySelect')
                this.modalGtdStatusSelect = document.getElementById('modalGtdStatusSelect')
                this.modalContextSelect = document.getElementById('modalContextSelect')
                this.modalDueDateInput = document.getElementById('modalDueDateInput')
                this.modalAddBtn = document.getElementById('modalAddBtn')
                this.modalTitle = document.getElementById('modalTitle')
                this.todoList = document.getElementById('todoList')
                this.categoryList = document.getElementById('categoryList')
                this.newCategoryInput = document.getElementById('newCategoryInput')
                this.addCategoryBtn = document.getElementById('addCategoryBtn')
                this.contextList = document.getElementById('contextList')
                this.newContextInput = document.getElementById('newContextInput')
                this.addContextBtn = document.getElementById('addContextBtn')
                this.gtdTabs = document.getElementById('gtdTabs')
                this.totalTodosEl = document.getElementById('totalTodos')
                this.completedTodosEl = document.getElementById('completedTodos')
                this.versionNumberEl = document.getElementById('versionNumber')
                this.themeSelect = document.getElementById('themeSelect')
                this.unlockModal = document.getElementById('unlockModal')
                this.unlockForm = document.getElementById('unlockForm')
                this.unlockPassword = document.getElementById('unlockPassword')
                this.unlockEmail = document.getElementById('unlockEmail')
                this.unlockError = document.getElementById('unlockError')
                this.unlockBtn = document.getElementById('unlockBtn')
                this.unlockLogoutBtn = document.getElementById('unlockLogoutBtn')

                this.initAuth()
                this.initEventListeners()
                this.setVersion()
                this.initTheme()
            }

            setVersion() {
                if (this.versionNumberEl) {
                    this.versionNumberEl.textContent = APP_VERSION
                }
            }

            async initAuth() {
                // Check current session
                const { data: { session } } = await supabase.auth.getSession()

                if (session) {
                    // Check if we have a stored password from a previous page load
                    const storedPassword = sessionStorage.getItem('_ep')
                    if (storedPassword) {
                        // Auto-unlock using stored password
                        try {
                            await this.initializeEncryption(session.user, storedPassword)
                            await this.handleAuthSuccess(session.user)
                            // handleAuthSuccess calls hideLoadingScreen after data loads
                        } catch (e) {
                            // If auto-unlock fails, clear stored password and show modal
                            console.error('Auto-unlock failed:', e)
                            sessionStorage.removeItem('_ep')
                            this.pendingUser = session.user
                            this.showUnlockModal()
                            this.hideLoadingScreen()
                        }
                    } else {
                        // No stored password, show unlock modal
                        this.pendingUser = session.user
                        this.showUnlockModal()
                        this.hideLoadingScreen()
                    }
                } else {
                    // No session, show auth container
                    this.authContainer.classList.add('active')
                    this.hideLoadingScreen()
                }

                // Listen for auth changes (only for sign out, sign in handled by login form)
                supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_OUT') {
                        this.handleSignOut()
                    }
                })
            }

            initEventListeners() {
                // Auth tab switching
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab
                        this.switchAuthTab(tabName)
                    })
                })

                // Login form
                this.loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault()
                    await this.handleLogin()
                })

                // Signup form
                this.signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault()
                    await this.handleSignup()
                })

                // Lock
                this.lockBtn.addEventListener('click', () => this.lockApp())

                // Logout
                this.logoutBtn.addEventListener('click', async () => {
                    await this.handleLogout()
                })

                // Settings modal controls
                this.settingsBtn.addEventListener('click', () => this.openSettingsModal())
                this.closeSettingsModalBtn.addEventListener('click', () => this.closeSettingsModal())
                this.cancelSettingsModalBtn.addEventListener('click', () => this.closeSettingsModal())
                this.settingsModal.addEventListener('click', (e) => {
                    if (e.target === this.settingsModal) this.closeSettingsModal()
                })

                // Save settings via form
                this.settingsForm.addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.saveSettings()
                })

                // Migrate existing data
                this.migrateDataBtn.addEventListener('click', () => this.migrateExistingData())

                // Modal controls
                this.openAddTodoModalBtn.addEventListener('click', () => this.openModal())
                this.closeModalBtn.addEventListener('click', () => this.closeModal())
                this.cancelModalBtn.addEventListener('click', () => this.closeModal())
                this.addTodoModal.addEventListener('click', (e) => {
                    if (e.target === this.addTodoModal) this.closeModal()
                })

                // Add/Edit todo via modal form
                this.addTodoForm.addEventListener('submit', (e) => {
                    e.preventDefault()
                    if (this.editingTodoId) {
                        this.updateTodo()
                    } else {
                        this.addTodo()
                    }
                })

                // Add category
                this.addCategoryBtn.addEventListener('click', () => this.addCategory())
                this.newCategoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCategory()
                })

                // Add context
                this.addContextBtn.addEventListener('click', () => this.addContext())
                this.newContextInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addContext()
                })

                // GTD tabs
                this.gtdTabs.querySelectorAll('.gtd-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const status = e.target.dataset.status
                        this.selectGtdStatus(status)
                    })

                    // Drop target for assigning GTD status (except 'all' tab)
                    const status = tab.dataset.status
                    if (status !== 'all') {
                        tab.addEventListener('dragover', (e) => {
                            e.preventDefault()
                            e.dataTransfer.dropEffect = 'move'
                            tab.classList.add('drag-over')
                        })
                        tab.addEventListener('dragleave', () => {
                            tab.classList.remove('drag-over')
                        })
                        tab.addEventListener('drop', (e) => {
                            e.preventDefault()
                            tab.classList.remove('drag-over')
                            const todoId = e.dataTransfer.getData('text/plain')
                            if (todoId) {
                                this.updateTodoGtdStatus(todoId, status)
                            }
                        })
                    }
                })

                // Unlock modal
                this.unlockForm.addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.handleUnlock()
                })
                this.unlockLogoutBtn.addEventListener('click', () => this.handleLogout())

                // Theme selector
                this.themeSelect.addEventListener('change', () => this.changeTheme())
            }

            switchAuthTab(tabName) {
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName)
                })
                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.toggle('active', form.id === `${tabName}Form`)
                })
                this.authMessage.innerHTML = ''
            }

            showMessage(message, type = 'error') {
                const className = type === 'error' ? 'error-message' : 'success-message'
                this.authMessage.innerHTML = `<div class="${className}">${this.escapeHtml(message)}</div>`
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value
                const password = document.getElementById('loginPassword').value

                const submitBtn = this.loginForm.querySelector('button[type="submit"]')
                submitBtn.disabled = true
                submitBtn.textContent = 'Logging in...'

                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                submitBtn.disabled = false
                submitBtn.textContent = 'Login'

                if (error) {
                    this.showMessage(error.message, 'error')
                } else {
                    await this.initializeEncryption(data.user, password)
                    // Store password in sessionStorage for page reload persistence
                    sessionStorage.setItem('_ep', password)

                    // Show loading screen while data loads
                    this.loadingScreen.classList.remove('hidden')

                    await this.handleAuthSuccess(data.user)
                }
            }

            async handleSignup() {
                const email = document.getElementById('signupEmail').value
                const password = document.getElementById('signupPassword').value
                const passwordConfirm = document.getElementById('signupPasswordConfirm').value

                if (password !== passwordConfirm) {
                    this.showMessage('Passwords do not match', 'error')
                    return
                }

                const submitBtn = this.signupForm.querySelector('button[type="submit"]')
                submitBtn.disabled = true
                submitBtn.textContent = 'Signing up...'

                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                })

                submitBtn.disabled = false
                submitBtn.textContent = 'Sign Up'

                if (error) {
                    this.showMessage(error.message, 'error')
                } else {
                    this.showMessage('Account created! Please check your email to confirm your account. You can now login.', 'success')
                    this.switchAuthTab('login')
                }
            }

            async handleLogout() {
                await supabase.auth.signOut()
            }

            async handleAuthSuccess(user) {
                this.currentUser = user
                this.userEmail.textContent = `(${user.email})`
                this.authContainer.classList.remove('active')
                this.appContainer.classList.add('active')
                this.mainContainer.classList.remove('auth-mode')

                // Load data and wait for essential items
                await Promise.all([
                    this.loadCategories(),
                    this.loadPriorities(),
                    this.loadContexts(),
                    this.loadTodos()
                ])

                // Load non-essential items without waiting
                this.loadThemeFromDatabase()
                this.loadUserSettings()

                // Hide loading screen after data is ready
                this.hideLoadingScreen()
            }

            hideLoadingScreen() {
                this.loadingScreen.classList.add('hidden')
                this.mainContainer.classList.remove('loading')
                this.mainContainer.classList.add('loaded')
            }

            handleSignOut() {
                this.currentUser = null
                this.encryptionKey = null
                this.todos = []
                this.categories = []
                this.priorities = []
                this.contexts = []
                this.selectedCategoryId = null
                this.selectedContextId = null
                this.selectedGtdStatus = 'all'
                sessionStorage.removeItem('_ep')
                this.authContainer.classList.add('active')
                this.appContainer.classList.remove('active')
                this.mainContainer.classList.add('auth-mode')
                this.loginForm.reset()
                this.signupForm.reset()
                this.authMessage.innerHTML = ''
                this.closeUnlockModal()
            }

            lockApp() {
                // Store current user for unlock verification
                this.pendingUser = this.currentUser

                // Clear sensitive data from memory and storage
                this.encryptionKey = null
                this.todos = []
                this.categories = []
                this.priorities = []
                this.contexts = []
                sessionStorage.removeItem('_ep')

                // Clear the UI
                this.todoList.innerHTML = ''
                this.categoryList.innerHTML = ''
                this.contextList.innerHTML = ''

                // Hide app and show unlock modal
                this.appContainer.classList.remove('active')
                this.mainContainer.classList.add('auth-mode')
                this.showUnlockModal()
            }

            showUnlockModal() {
                this.unlockModal.classList.add('active')
                this.unlockError.style.display = 'none'
                this.unlockEmail.value = this.pendingUser?.email || ''
                this.unlockPassword.value = ''
                setTimeout(() => this.unlockPassword.focus(), 100)
            }

            closeUnlockModal() {
                this.unlockModal.classList.remove('active')
                this.unlockPassword.value = ''
                this.unlockError.style.display = 'none'
                this.pendingUser = null
            }

            async handleUnlock() {
                const password = this.unlockPassword.value

                if (!password) {
                    this.unlockError.textContent = 'Please enter your password'
                    this.unlockError.style.display = 'block'
                    return
                }

                this.unlockBtn.disabled = true
                this.unlockBtn.textContent = 'Unlocking...'
                this.unlockError.style.display = 'none'

                try {
                    // Verify password by attempting to sign in
                    const { error } = await supabase.auth.signInWithPassword({
                        email: this.pendingUser.email,
                        password: password
                    })

                    if (error) {
                        this.unlockError.textContent = 'Incorrect password'
                        this.unlockError.style.display = 'block'
                        this.unlockBtn.disabled = false
                        this.unlockBtn.textContent = 'Unlock'
                        return
                    }

                    // Initialize encryption with the verified password
                    await this.initializeEncryption(this.pendingUser, password)

                    // Store password in sessionStorage for page reload persistence
                    sessionStorage.setItem('_ep', password)

                    // Save user reference before closing modal (closeUnlockModal clears pendingUser)
                    const user = this.pendingUser

                    // Close modal and proceed to app
                    this.closeUnlockModal()

                    // Show loading screen while data loads
                    this.loadingScreen.classList.remove('hidden')

                    await this.handleAuthSuccess(user)
                } catch (e) {
                    console.error('Unlock error:', e)
                    this.unlockError.textContent = 'Failed to unlock. Please try again.'
                    this.unlockError.style.display = 'block'
                } finally {
                    this.unlockBtn.disabled = false
                    this.unlockBtn.textContent = 'Unlock'
                }
            }

            // Initialize encryption key from password
            async initializeEncryption(user, password) {
                // Try to load existing salt from user_settings
                const { data: settings } = await supabase
                    .from('user_settings')
                    .select('encryption_salt')
                    .eq('user_id', user.id)
                    .single()

                let salt
                if (settings && settings.encryption_salt) {
                    // Use existing salt
                    salt = CryptoUtils.base64ToArray(settings.encryption_salt)
                } else {
                    // Generate new salt for new users
                    salt = CryptoUtils.generateSalt()
                    const saltBase64 = CryptoUtils.arrayToBase64(salt)

                    // Save salt to user_settings
                    const { error: updateError } = await supabase
                        .from('user_settings')
                        .upsert({
                            user_id: user.id,
                            encryption_salt: saltBase64,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'user_id' })

                    if (updateError) {
                        console.error('Error saving encryption salt:', updateError)
                    }
                }

                // Derive encryption key from password and salt
                this.encryptionKey = await CryptoUtils.deriveKey(password, salt)
            }

            // Encrypt text if encryption is enabled
            async encrypt(plaintext) {
                if (!this.encryptionKey) return plaintext
                return await CryptoUtils.encrypt(plaintext, this.encryptionKey)
            }

            // Decrypt text if encryption is enabled
            async decrypt(ciphertext) {
                if (!this.encryptionKey) return ciphertext
                // Check if this looks like encrypted data (base64 with minimum length for IV + data)
                if (!ciphertext || ciphertext.length < 20) return ciphertext
                try {
                    return await CryptoUtils.decrypt(ciphertext, this.encryptionKey)
                } catch (e) {
                    // If decryption fails, return original (might be unencrypted legacy data)
                    console.warn('Decryption failed, returning original text:', e)
                    return ciphertext
                }
            }

            async loadCategories() {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('created_at', { ascending: true })

                if (error) {
                    console.error('Error loading categories:', error)
                    return
                }

                // Decrypt category names
                this.categories = await Promise.all(data.map(async (category) => ({
                    ...category,
                    name: await this.decrypt(category.name)
                })))
                this.renderCategories()
                this.updateCategorySelect()
            }

            async loadPriorities() {
                const { data, error } = await supabase
                    .from('priorities')
                    .select('*')
                    .order('level', { ascending: true })

                if (error) {
                    console.error('Error loading priorities:', error)
                    return
                }

                this.priorities = data
                this.updatePrioritySelect()
            }

            updatePrioritySelect() {
                // Keep first option (No Priority)
                this.modalPrioritySelect.innerHTML = '<option value="">No Priority</option>'

                this.priorities.forEach(priority => {
                    const option = document.createElement('option')
                    option.value = priority.id
                    option.textContent = priority.name
                    this.modalPrioritySelect.appendChild(option)
                })
            }

            async loadContexts() {
                const { data, error } = await supabase
                    .from('contexts')
                    .select('*')
                    .order('created_at', { ascending: true })

                if (error) {
                    console.error('Error loading contexts:', error)
                    return
                }

                // Decrypt context names
                this.contexts = await Promise.all(data.map(async (context) => ({
                    ...context,
                    name: await this.decrypt(context.name)
                })))
                this.renderContexts()
                this.updateContextSelect()
            }

            renderContexts() {
                this.contextList.innerHTML = ''

                // Add "All Contexts" option (also acts as "No Context" drop target)
                const allItem = document.createElement('li')
                allItem.className = `context-item ${this.selectedContextId === null ? 'active' : ''}`
                allItem.innerHTML = `<span class="context-name">All Contexts</span>`
                allItem.addEventListener('click', () => this.selectContext(null))

                // Drop target for removing context
                allItem.addEventListener('dragover', (e) => {
                    e.preventDefault()
                    e.dataTransfer.dropEffect = 'move'
                    allItem.classList.add('drag-over')
                })
                allItem.addEventListener('dragleave', () => {
                    allItem.classList.remove('drag-over')
                })
                allItem.addEventListener('drop', (e) => {
                    e.preventDefault()
                    allItem.classList.remove('drag-over')
                    const todoId = e.dataTransfer.getData('text/plain')
                    if (todoId) {
                        this.updateTodoContext(todoId, null)
                    }
                })
                this.contextList.appendChild(allItem)

                // Add user contexts
                this.contexts.forEach(context => {
                    const li = document.createElement('li')
                    li.className = `context-item ${this.selectedContextId === context.id ? 'active' : ''}`
                    li.innerHTML = `
                        <span class="context-name">${this.escapeHtml(context.name)}</span>
                        <button class="context-delete" data-id="${context.id}">√ó</button>
                    `

                    li.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('context-delete')) {
                            this.selectContext(context.id)
                        }
                    })

                    // Drop target for assigning context
                    li.addEventListener('dragover', (e) => {
                        e.preventDefault()
                        e.dataTransfer.dropEffect = 'move'
                        li.classList.add('drag-over')
                    })
                    li.addEventListener('dragleave', () => {
                        li.classList.remove('drag-over')
                    })
                    li.addEventListener('drop', (e) => {
                        e.preventDefault()
                        li.classList.remove('drag-over')
                        const todoId = e.dataTransfer.getData('text/plain')
                        if (todoId) {
                            this.updateTodoContext(todoId, context.id)
                        }
                    })

                    const deleteBtn = li.querySelector('.context-delete')
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation()
                        this.deleteContext(context.id)
                    })

                    this.contextList.appendChild(li)
                })
            }

            updateContextSelect() {
                this.modalContextSelect.innerHTML = '<option value="">No Context</option>'

                this.contexts.forEach(context => {
                    const option = document.createElement('option')
                    option.value = context.id
                    option.textContent = context.name
                    this.modalContextSelect.appendChild(option)
                })
            }

            selectContext(contextId) {
                // Toggle: clicking already-selected context deselects it (shows all)
                if (this.selectedContextId === contextId) {
                    this.selectedContextId = null
                } else {
                    this.selectedContextId = contextId
                }
                this.renderContexts()
                this.renderTodos()
            }

            async addContext() {
                let name = this.newContextInput.value.trim()
                if (!name) return

                // Auto-prefix with @ if not already prefixed
                if (!name.startsWith('@')) {
                    name = '@' + name
                }

                this.addContextBtn.disabled = true
                this.addContextBtn.textContent = 'Adding...'

                // Encrypt context name before storing
                const encryptedName = await this.encrypt(name)

                const { data, error } = await supabase
                    .from('contexts')
                    .insert({
                        user_id: this.currentUser.id,
                        name: encryptedName
                    })
                    .select()

                this.addContextBtn.disabled = false
                this.addContextBtn.textContent = 'Add Context'

                if (error) {
                    console.error('Error adding context:', error)
                    alert('Failed to add context')
                    return
                }

                // Store decrypted name in local state for rendering
                const contextWithDecryptedName = { ...data[0], name: name }
                this.contexts.push(contextWithDecryptedName)
                this.newContextInput.value = ''
                this.renderContexts()
                this.updateContextSelect()
            }

            async deleteContext(contextId) {
                if (!confirm('Delete this context? Todos with this context will become contextless.')) {
                    return
                }

                const { error } = await supabase
                    .from('contexts')
                    .delete()
                    .eq('id', contextId)

                if (error) {
                    console.error('Error deleting context:', error)
                    alert('Failed to delete context')
                    return
                }

                this.contexts = this.contexts.filter(c => c.id !== contextId)
                if (this.selectedContextId === contextId) {
                    this.selectedContextId = null
                }
                this.renderContexts()
                this.updateContextSelect()
                this.loadTodos()
            }

            selectGtdStatus(status) {
                this.selectedGtdStatus = status

                // Update active tab styling
                this.gtdTabs.querySelectorAll('.gtd-tab').forEach(tab => {
                    const isActive = tab.dataset.status === status
                    tab.classList.toggle('active', isActive)
                    tab.setAttribute('aria-selected', isActive ? 'true' : 'false')
                })

                this.renderTodos()
            }

            async loadTodos() {
                this.todoList.innerHTML = '<div class="loading-state">Loading todos...</div>'

                const { data, error } = await supabase
                    .from('todos')
                    .select('*')
                    .order('created_at', { ascending: true })

                if (error) {
                    console.error('Error loading todos:', error)
                    this.todoList.innerHTML = '<div class="error-message">Failed to load todos</div>'
                    return
                }

                // Decrypt todo texts
                this.todos = await Promise.all(data.map(async (todo) => ({
                    ...todo,
                    text: await this.decrypt(todo.text)
                })))
                this.renderTodos()
            }

            renderCategories() {
                this.categoryList.innerHTML = ''

                // Add "All" category
                const allItem = document.createElement('li')
                allItem.className = `category-item ${this.selectedCategoryId === null ? 'active' : ''}`
                allItem.innerHTML = `
                    <span class="category-name">All Todos</span>
                `
                allItem.addEventListener('click', () => this.selectCategory(null))
                this.categoryList.appendChild(allItem)

                // Add "Uncategorized" as drop target to remove category
                const uncategorizedItem = document.createElement('li')
                uncategorizedItem.className = `category-item ${this.selectedCategoryId === 'uncategorized' ? 'active' : ''}`
                uncategorizedItem.innerHTML = `
                    <span class="category-name">Uncategorized</span>
                `
                uncategorizedItem.addEventListener('click', () => this.selectCategory('uncategorized'))

                // Drop target for removing category
                uncategorizedItem.addEventListener('dragover', (e) => {
                    e.preventDefault()
                    e.dataTransfer.dropEffect = 'move'
                    uncategorizedItem.classList.add('drag-over')
                })
                uncategorizedItem.addEventListener('dragleave', () => {
                    uncategorizedItem.classList.remove('drag-over')
                })
                uncategorizedItem.addEventListener('drop', (e) => {
                    e.preventDefault()
                    uncategorizedItem.classList.remove('drag-over')
                    const todoId = e.dataTransfer.getData('text/plain')
                    if (todoId) {
                        this.updateTodoCategory(todoId, null)
                    }
                })
                this.categoryList.appendChild(uncategorizedItem)

                // Add user categories
                this.categories.forEach(category => {
                    const li = document.createElement('li')
                    li.className = `category-item ${this.selectedCategoryId === category.id ? 'active' : ''}`
                    li.innerHTML = `
                        <span class="category-name">
                            <span class="category-color" style="background-color: ${this.validateColor(category.color)}"></span>
                            ${this.escapeHtml(category.name)}
                        </span>
                        <button class="category-delete" data-id="${category.id}">√ó</button>
                    `

                    li.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('category-delete')) {
                            this.selectCategory(category.id)
                        }
                    })

                    // Drop target for assigning category
                    li.addEventListener('dragover', (e) => {
                        e.preventDefault()
                        e.dataTransfer.dropEffect = 'move'
                        li.classList.add('drag-over')
                    })
                    li.addEventListener('dragleave', () => {
                        li.classList.remove('drag-over')
                    })
                    li.addEventListener('drop', (e) => {
                        e.preventDefault()
                        li.classList.remove('drag-over')
                        const todoId = e.dataTransfer.getData('text/plain')
                        if (todoId) {
                            this.updateTodoCategory(todoId, category.id)
                        }
                    })

                    const deleteBtn = li.querySelector('.category-delete')
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation()
                        this.deleteCategory(category.id)
                    })

                    this.categoryList.appendChild(li)
                })
            }

            updateCategorySelect() {
                // Update modal category select
                this.modalCategorySelect.innerHTML = '<option value="">No Category</option>'

                this.categories.forEach(category => {
                    const option = document.createElement('option')
                    option.value = category.id
                    option.textContent = category.name
                    this.modalCategorySelect.appendChild(option)
                })
            }

            selectCategory(categoryId) {
                // Toggle: clicking already-selected category deselects it (shows all)
                if (this.selectedCategoryId === categoryId) {
                    this.selectedCategoryId = null
                } else {
                    this.selectedCategoryId = categoryId
                }

                // Pre-select category in modal when opening
                if (this.selectedCategoryId && this.selectedCategoryId !== 'uncategorized') {
                    this.modalCategorySelect.value = this.selectedCategoryId
                } else {
                    this.modalCategorySelect.value = ''
                }

                this.renderCategories()
                this.renderTodos()
            }

            openModal() {
                this.editingTodoId = null
                this.modalTitle.textContent = 'Add New Todo'
                this.modalAddBtn.textContent = 'Add Todo'
                this.addTodoModal.classList.add('active')
                this.modalTodoInput.value = ''
                this.modalDueDateInput.value = ''
                this.modalPrioritySelect.value = ''
                this.modalGtdStatusSelect.value = 'inbox'
                this.modalContextSelect.value = ''

                // Pre-select the current category
                if (this.selectedCategoryId && this.selectedCategoryId !== 'uncategorized') {
                    this.modalCategorySelect.value = this.selectedCategoryId
                } else {
                    this.modalCategorySelect.value = ''
                }

                // Handle Escape key to close modal
                this.handleEscapeKey = (e) => {
                    if (e.key === 'Escape') this.closeModal()
                }
                document.addEventListener('keydown', this.handleEscapeKey)

                // Focus on the input
                setTimeout(() => this.modalTodoInput.focus(), 100)
            }

            openEditModal(todoId) {
                const todo = this.todos.find(t => t.id === todoId)
                if (!todo) return

                this.editingTodoId = todoId
                this.modalTitle.textContent = 'Edit Todo'
                this.modalAddBtn.textContent = 'Save Changes'
                this.addTodoModal.classList.add('active')

                // Pre-populate fields with existing todo data
                this.modalTodoInput.value = todo.text
                this.modalCategorySelect.value = todo.category_id || ''
                this.modalPrioritySelect.value = todo.priority_id || ''
                this.modalGtdStatusSelect.value = todo.gtd_status || 'inbox'
                this.modalContextSelect.value = todo.context_id || ''
                this.modalDueDateInput.value = todo.due_date || ''

                // Handle Escape key to close modal
                this.handleEscapeKey = (e) => {
                    if (e.key === 'Escape') this.closeModal()
                }
                document.addEventListener('keydown', this.handleEscapeKey)

                // Focus on the input
                setTimeout(() => this.modalTodoInput.focus(), 100)
            }

            closeModal() {
                this.addTodoModal.classList.remove('active')
                this.editingTodoId = null

                // Remove escape key listener
                if (this.handleEscapeKey) {
                    document.removeEventListener('keydown', this.handleEscapeKey)
                }

                this.modalTodoInput.value = ''
                this.modalCategorySelect.value = ''
                this.modalPrioritySelect.value = ''
                this.modalGtdStatusSelect.value = 'inbox'
                this.modalContextSelect.value = ''
                this.modalDueDateInput.value = ''

                // Reset modal to add mode
                this.modalTitle.textContent = 'Add New Todo'
                this.modalAddBtn.textContent = 'Add Todo'

                // Return focus to the trigger button for accessibility
                if (this.openAddTodoModalBtn && typeof this.openAddTodoModalBtn.focus === 'function') {
                    this.openAddTodoModalBtn.focus()
                }
            }

            async addCategory() {
                const name = this.newCategoryInput.value.trim()
                if (!name) return

                this.addCategoryBtn.disabled = true
                this.addCategoryBtn.textContent = 'Adding...'

                // Generate a random color
                const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#feca57', '#ee5a6f', '#c471ed']
                const color = colors[Math.floor(Math.random() * colors.length)]

                // Encrypt category name before storing
                const encryptedName = await this.encrypt(name)

                const { data, error } = await supabase
                    .from('categories')
                    .insert({
                        user_id: this.currentUser.id,
                        name: encryptedName,
                        color: color
                    })
                    .select()

                this.addCategoryBtn.disabled = false
                this.addCategoryBtn.textContent = 'Add Category'

                if (error) {
                    console.error('Error adding category:', error)
                    if (error.code === '23505') {
                        alert('A category with this name already exists')
                    } else {
                        alert('Failed to add category')
                    }
                    return
                }

                // Store decrypted name in local state for rendering
                const categoryWithDecryptedName = { ...data[0], name: name }
                this.categories.push(categoryWithDecryptedName)
                this.newCategoryInput.value = ''
                this.renderCategories()
                this.updateCategorySelect()
            }

            async deleteCategory(categoryId) {
                if (!confirm('Delete this category? Todos in this category will become uncategorized.')) {
                    return
                }

                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', categoryId)

                if (error) {
                    console.error('Error deleting category:', error)
                    alert('Failed to delete category')
                    return
                }

                this.categories = this.categories.filter(c => c.id !== categoryId)
                if (this.selectedCategoryId === categoryId) {
                    this.selectedCategoryId = null
                }
                this.renderCategories()
                this.updateCategorySelect()
                this.loadTodos()
            }

            async addTodo() {
                const text = this.modalTodoInput.value.trim()
                if (!text) return

                this.modalAddBtn.disabled = true
                this.modalAddBtn.textContent = 'Adding...'

                const categoryId = this.modalCategorySelect.value || null
                const priorityId = this.modalPrioritySelect.value || null
                const gtdStatus = this.modalGtdStatusSelect.value || 'inbox'
                const contextId = this.modalContextSelect.value || null
                const dueDate = this.modalDueDateInput.value || null

                // Encrypt todo text before storing
                const encryptedText = await this.encrypt(text)

                const { data, error } = await supabase
                    .from('todos')
                    .insert({
                        user_id: this.currentUser.id,
                        text: encryptedText,
                        completed: false,
                        category_id: categoryId,
                        priority_id: priorityId,
                        gtd_status: gtdStatus,
                        context_id: contextId,
                        due_date: dueDate
                    })
                    .select()

                this.modalAddBtn.disabled = false
                this.modalAddBtn.textContent = 'Add Todo'

                if (error) {
                    console.error('Error adding todo:', error)
                    alert('Failed to add todo')
                    return
                }

                // Store decrypted text in local state for rendering
                const todoWithDecryptedText = { ...data[0], text: text }
                this.todos.push(todoWithDecryptedText)
                this.closeModal()
                this.renderTodos()
            }

            async updateTodo() {
                const text = this.modalTodoInput.value.trim()
                if (!text || !this.editingTodoId) return

                this.modalAddBtn.disabled = true
                this.modalAddBtn.textContent = 'Saving...'

                const categoryId = this.modalCategorySelect.value || null
                const priorityId = this.modalPrioritySelect.value || null
                const gtdStatus = this.modalGtdStatusSelect.value || 'inbox'
                const contextId = this.modalContextSelect.value || null
                const dueDate = this.modalDueDateInput.value || null

                // Encrypt todo text before storing
                const encryptedText = await this.encrypt(text)

                const { error } = await supabase
                    .from('todos')
                    .update({
                        text: encryptedText,
                        category_id: categoryId,
                        priority_id: priorityId,
                        gtd_status: gtdStatus,
                        context_id: contextId,
                        due_date: dueDate
                    })
                    .eq('id', this.editingTodoId)

                this.modalAddBtn.disabled = false
                this.modalAddBtn.textContent = 'Save Changes'

                if (error) {
                    console.error('Error updating todo:', error)
                    alert('Failed to update todo')
                    return
                }

                // Update local state
                const todoIndex = this.todos.findIndex(t => t.id === this.editingTodoId)
                if (todoIndex !== -1) {
                    this.todos[todoIndex] = {
                        ...this.todos[todoIndex],
                        text: text,
                        category_id: categoryId,
                        priority_id: priorityId,
                        gtd_status: gtdStatus,
                        context_id: contextId,
                        due_date: dueDate
                    }
                }

                this.closeModal()
                this.renderTodos()
            }

            async toggleTodo(id) {
                const todo = this.todos.find(t => t.id === id)
                if (!todo) return

                const newCompleted = !todo.completed

                const { error } = await supabase
                    .from('todos')
                    .update({ completed: newCompleted })
                    .eq('id', id)

                if (error) {
                    console.error('Error updating todo:', error)
                    alert('Failed to update todo')
                    return
                }

                todo.completed = newCompleted
                this.renderTodos()
            }

            async deleteTodo(id) {
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('id', id)

                if (error) {
                    console.error('Error deleting todo:', error)
                    alert('Failed to delete todo')
                    return
                }

                this.todos = this.todos.filter(t => t.id !== id)
                this.renderTodos()
            }

            // Drag-and-drop update methods
            async updateTodoCategory(todoId, categoryId) {
                const { error } = await supabase
                    .from('todos')
                    .update({ category_id: categoryId })
                    .eq('id', todoId)

                if (error) {
                    console.error('Error updating todo category:', error)
                    alert('Failed to update todo category')
                    return
                }

                // Reload todos to ensure UI is in sync
                await this.loadTodos()
            }

            async updateTodoContext(todoId, contextId) {
                const { error } = await supabase
                    .from('todos')
                    .update({ context_id: contextId })
                    .eq('id', todoId)

                if (error) {
                    console.error('Error updating todo context:', error)
                    alert('Failed to update todo context')
                    return
                }

                // Reload todos to ensure UI is in sync
                await this.loadTodos()
            }

            async updateTodoGtdStatus(todoId, gtdStatus) {
                const { error } = await supabase
                    .from('todos')
                    .update({ gtd_status: gtdStatus })
                    .eq('id', todoId)

                if (error) {
                    console.error('Error updating todo GTD status:', error)
                    alert('Failed to update todo GTD status')
                    return
                }

                // Reload todos to ensure UI is in sync
                await this.loadTodos()
            }

            getFilteredTodos() {
                let filtered = this.todos

                // Filter by category
                if (this.selectedCategoryId === 'uncategorized') {
                    filtered = filtered.filter(t => !t.category_id)
                } else if (this.selectedCategoryId !== null) {
                    filtered = filtered.filter(t => t.category_id === this.selectedCategoryId)
                }

                // Filter by context
                if (this.selectedContextId !== null) {
                    filtered = filtered.filter(t => t.context_id === this.selectedContextId)
                }

                // Filter by GTD status
                if (this.selectedGtdStatus !== 'all') {
                    filtered = filtered.filter(t => t.gtd_status === this.selectedGtdStatus)
                }

                // Sort by priority level (lower level = higher priority)
                // Use slice() to avoid mutating the original array
                return filtered.slice().sort((a, b) => {
                    const priorityA = a.priority_id ? this.getPriorityById(a.priority_id) : null
                    const priorityB = b.priority_id ? this.getPriorityById(b.priority_id) : null

                    if (!priorityA && !priorityB) return 0
                    if (!priorityA) return 1
                    if (!priorityB) return -1

                    return priorityA.level - priorityB.level
                })
            }

            getCategoryById(id) {
                return this.categories.find(c => c.id === id)
            }

            getPriorityById(id) {
                return this.priorities.find(p => p.id === id)
            }

            getContextById(id) {
                return this.contexts.find(c => c.id === id)
            }

            getGtdStatusLabel(status) {
                const labels = {
                    'inbox': 'Inbox',
                    'next_action': 'Next',
                    'waiting_for': 'Waiting',
                    'someday_maybe': 'Someday'
                }
                return labels[status] || status
            }

            updateStats() {
                const filteredTodos = this.getFilteredTodos()
                const total = filteredTodos.length
                const completed = filteredTodos.filter(t => t.completed).length
                this.totalTodosEl.textContent = `Total: ${total}`
                this.completedTodosEl.textContent = `Completed: ${completed}`
            }

            renderTodos() {
                this.todoList.innerHTML = ''
                const filteredTodos = this.getFilteredTodos()

                if (filteredTodos.length === 0) {
                    const emptyMsg = this.selectedCategoryId === null
                        ? 'No todos yet. Add one above!'
                        : 'No todos in this category.'
                    this.todoList.innerHTML = `<div class="empty-state">${emptyMsg}</div>`
                } else {
                    filteredTodos.forEach(todo => {
                        const li = document.createElement('li')
                        li.className = `todo-item ${todo.completed ? 'completed' : ''}`
                        li.draggable = true
                        li.dataset.todoId = todo.id

                        // Drag event handlers
                        li.addEventListener('dragstart', (e) => {
                            e.dataTransfer.setData('text/plain', todo.id)
                            e.dataTransfer.effectAllowed = 'move'
                            li.classList.add('dragging')
                        })
                        li.addEventListener('dragend', () => {
                            li.classList.remove('dragging')
                        })

                        const category = todo.category_id ? (this.getCategoryById(todo.category_id) ?? null) : null
                        const categoryBadge = category
                            ? `<span class="todo-category-badge" style="background-color: ${this.validateColor(category.color)}">${this.escapeHtml(category.name)}</span>`
                            : ''

                        const priority = todo.priority_id ? (this.getPriorityById(todo.priority_id) ?? null) : null
                        const priorityBadge = priority
                            ? `<span class="todo-priority-badge" style="background-color: ${this.validateColor(priority.color)}">${this.escapeHtml(priority.name)}</span>`
                            : ''

                        const gtdStatus = todo.gtd_status || 'inbox'
                        const gtdBadge = `<span class="todo-gtd-badge ${gtdStatus}">${this.escapeHtml(this.getGtdStatusLabel(gtdStatus))}</span>`

                        const context = todo.context_id ? (this.getContextById(todo.context_id) ?? null) : null
                        const contextBadge = context
                            ? `<span class="todo-context-badge">${this.escapeHtml(context.name)}</span>`
                            : ''

                        const dateBadge = todo.due_date ? this.formatDateBadge(todo.due_date) : ''

                        if (category) {
                            li.style.borderLeftColor = this.validateColor(category.color)
                        }

                        li.innerHTML = `
                            <input
                                type="checkbox"
                                class="todo-checkbox"
                                ${todo.completed ? 'checked' : ''}
                                data-id="${todo.id}"
                            >
                            <span class="todo-text">${this.escapeHtml(todo.text)}</span>
                            ${gtdBadge}
                            ${priorityBadge}
                            ${contextBadge}
                            ${dateBadge}
                            ${categoryBadge}
                            <button class="edit-btn" data-id="${todo.id}">Edit</button>
                            <button class="delete-btn" data-id="${todo.id}">Delete</button>
                        `

                        const checkbox = li.querySelector('.todo-checkbox')
                        checkbox.addEventListener('change', () => this.toggleTodo(todo.id))

                        const editBtn = li.querySelector('.edit-btn')
                        editBtn.addEventListener('click', () => this.openEditModal(todo.id))

                        const deleteBtn = li.querySelector('.delete-btn')
                        deleteBtn.addEventListener('click', () => this.deleteTodo(todo.id))

                        this.todoList.appendChild(li)
                    })
                }

                this.updateStats()
            }

            escapeHtml(text) {
                const div = document.createElement('div')
                div.textContent = text
                return div.innerHTML
            }

            validateColor(color) {
                // Validate hex color format to prevent CSS injection
                const hexColorRegex = /^#[0-9A-Fa-f]{6}$/
                return hexColorRegex.test(color) ? color : '#667eea'
            }

            formatDateBadge(dateString) {
                // Parse dateString as YYYY-MM-DD in a timezone-agnostic way
                const [year, month, day] = dateString.split('-')
                const dueDate = new Date(year, month - 1, day)

                const today = new Date()
                today.setHours(0, 0, 0, 0)

                const diffTime = dueDate - today
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

                let className = 'todo-date'
                let label = ''

                if (diffDays < 0) {
                    className += ' overdue'
                    label = diffDays === -1 ? 'Yesterday' : `${Math.abs(diffDays)} days ago`
                } else if (diffDays === 0) {
                    className += ' today'
                    label = 'Today'
                } else if (diffDays === 1) {
                    label = 'Tomorrow'
                } else if (diffDays <= 7) {
                    label = `In ${diffDays} days`
                } else {
                    // Format as readable date with consistent format
                    const monthName = dueDate.toLocaleDateString('en-US', { month: 'short' })
                    const dayNum = dueDate.getDate()
                    label = `${monthName} ${dayNum}`
                }

                return `<span class="${className}">${this.escapeHtml(label)}</span>`
            }

            initTheme() {
                // Load theme from localStorage first (instant)
                const savedTheme = localStorage.getItem('colorTheme') || 'purple'
                this.applyTheme(savedTheme)
                this.themeSelect.value = savedTheme

                // If user is logged in, load from database
                if (this.currentUser) {
                    this.loadThemeFromDatabase()
                }
            }

            async loadThemeFromDatabase() {
                const { data, error } = await supabase
                    .from('user_settings')
                    .select('color_theme')
                    .eq('user_id', this.currentUser.id)
                    .single()

                if (error) {
                    console.error('Error loading theme:', error)
                    return
                }

                if (data && data.color_theme) {
                    const dbTheme = data.color_theme
                    this.applyTheme(dbTheme)
                    this.themeSelect.value = dbTheme
                    localStorage.setItem('colorTheme', dbTheme)
                }
            }

            async changeTheme() {
                const selectedTheme = this.themeSelect.value
                this.applyTheme(selectedTheme)

                // Save to localStorage for instant loading
                localStorage.setItem('colorTheme', selectedTheme)

                // Save to database if user is logged in
                if (this.currentUser) {
                    await this.saveThemeToDatabase(selectedTheme)
                }
            }

            async saveThemeToDatabase(theme) {
                // Try to update existing setting
                const { data, error: updateError } = await supabase
                    .from('user_settings')
                    .update({ color_theme: theme, updated_at: new Date().toISOString() })
                    .eq('user_id', this.currentUser.id)
                    .select()

                if (updateError) {
                    console.error('Error updating user_settings:', updateError)
                }

                // If no rows were updated, insert a new one
                if (updateError || !data || data.length === 0) {
                    const { error: insertError } = await supabase
                        .from('user_settings')
                        .insert({
                            user_id: this.currentUser.id,
                            color_theme: theme,
                            updated_at: new Date().toISOString()
                        })
                    if (insertError) {
                        console.error('Error inserting into user_settings:', insertError)
                    }
                }
            }

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme)
            }

            async loadUserSettings() {
                const { data, error } = await supabase
                    .from('user_settings')
                    .select('username')
                    .eq('user_id', this.currentUser.id)
                    .single()

                if (error) {
                    // No settings yet, use email as display
                    this.userDisplay.textContent = this.currentUser.email
                    return
                }

                if (data && data.username) {
                    this.userDisplay.textContent = data.username
                } else {
                    this.userDisplay.textContent = this.currentUser.email
                }
            }

            openSettingsModal() {
                this.settingsModal.classList.add('active')

                // Load current username into input
                const currentUsername = this.userDisplay.textContent
                if (currentUsername !== this.currentUser.email) {
                    this.usernameInput.value = currentUsername
                } else {
                    this.usernameInput.value = ''
                }

                // Handle Escape key to close modal
                this.handleSettingsEscapeKey = (e) => {
                    if (e.key === 'Escape') this.closeSettingsModal()
                }
                document.addEventListener('keydown', this.handleSettingsEscapeKey)

                // Focus on the input
                setTimeout(() => this.usernameInput.focus(), 100)
            }

            closeSettingsModal() {
                this.settingsModal.classList.remove('active')

                // Remove escape key listener
                if (this.handleSettingsEscapeKey) {
                    document.removeEventListener('keydown', this.handleSettingsEscapeKey)
                }

                this.usernameInput.value = ''

                // Return focus to settings button for accessibility
                if (this.settingsBtn && typeof this.settingsBtn.focus === 'function') {
                    this.settingsBtn.focus()
                }
            }

            async saveSettings() {
                const username = this.usernameInput.value.trim()

                this.saveSettingsBtn.disabled = true
                this.saveSettingsBtn.textContent = 'Saving...'

                // Try to update existing settings
                const { data, error: updateError } = await supabase
                    .from('user_settings')
                    .update({ username: username || null, updated_at: new Date().toISOString() })
                    .eq('user_id', this.currentUser.id)
                    .select()

                if (updateError) {
                    console.error('Error updating user_settings:', updateError)
                }

                // If no rows were updated, insert a new one
                if (updateError || !data || data.length === 0) {
                    const { error: insertError } = await supabase
                        .from('user_settings')
                        .insert({
                            user_id: this.currentUser.id,
                            username: username || null,
                            updated_at: new Date().toISOString()
                        })
                    if (insertError) {
                        console.error('Error inserting into user_settings:', insertError)
                        alert('Failed to save settings')
                        this.saveSettingsBtn.disabled = false
                        this.saveSettingsBtn.textContent = 'Save Settings'
                        return
                    }
                }

                this.saveSettingsBtn.disabled = false
                this.saveSettingsBtn.textContent = 'Save Settings'

                // Update display
                if (username) {
                    this.userDisplay.textContent = username
                } else {
                    this.userDisplay.textContent = this.currentUser.email
                }

                this.closeSettingsModal()
            }

            // Check if a string looks like encrypted data (base64 with IV prefix)
            isEncrypted(text) {
                if (!text || text.length < 24) return false
                // Encrypted data is base64 with at least 12 bytes IV + some ciphertext
                // Base64 of 24+ bytes = 32+ characters
                const base64Regex = /^[A-Za-z0-9+/]+=*$/
                return base64Regex.test(text) && text.length >= 32
            }

            async migrateExistingData() {
                if (!this.encryptionKey) {
                    this.migrateStatus.textContent = 'Error: Encryption key not available. Please log out and log in again.'
                    this.migrateStatus.style.color = '#c33'
                    this.migrateStatus.style.display = 'block'
                    return
                }

                this.migrateDataBtn.disabled = true
                this.migrateDataBtn.textContent = 'Encrypting...'
                this.migrateStatus.style.display = 'none'

                let todosEncrypted = 0
                let categoriesEncrypted = 0
                let errors = 0

                try {
                    // Load todos directly from database (not using cached decrypted data)
                    const { data: todos, error: todosError } = await supabase
                        .from('todos')
                        .select('id, text')

                    if (todosError) {
                        throw new Error('Failed to load todos: ' + todosError.message)
                    }

                    // Encrypt unencrypted todos
                    for (const todo of todos) {
                        if (!this.isEncrypted(todo.text)) {
                            try {
                                const encryptedText = await CryptoUtils.encrypt(todo.text, this.encryptionKey)
                                const { error } = await supabase
                                    .from('todos')
                                    .update({ text: encryptedText })
                                    .eq('id', todo.id)

                                if (error) {
                                    console.error('Error encrypting todo:', error)
                                    errors++
                                } else {
                                    todosEncrypted++
                                }
                            } catch (e) {
                                console.error('Encryption error for todo:', e)
                                errors++
                            }
                        }
                    }

                    // Load categories directly from database
                    const { data: categories, error: categoriesError } = await supabase
                        .from('categories')
                        .select('id, name')

                    if (categoriesError) {
                        throw new Error('Failed to load categories: ' + categoriesError.message)
                    }

                    // Encrypt unencrypted categories
                    for (const category of categories) {
                        if (!this.isEncrypted(category.name)) {
                            try {
                                const encryptedName = await CryptoUtils.encrypt(category.name, this.encryptionKey)
                                const { error } = await supabase
                                    .from('categories')
                                    .update({ name: encryptedName })
                                    .eq('id', category.id)

                                if (error) {
                                    console.error('Error encrypting category:', error)
                                    errors++
                                } else {
                                    categoriesEncrypted++
                                }
                            } catch (e) {
                                console.error('Encryption error for category:', e)
                                errors++
                            }
                        }
                    }

                    // Reload data to show encrypted versions
                    await this.loadCategories()
                    await this.loadTodos()

                    // Show result
                    if (todosEncrypted === 0 && categoriesEncrypted === 0) {
                        this.migrateStatus.textContent = 'All data is already encrypted!'
                        this.migrateStatus.style.color = '#3c3'
                    } else {
                        let message = `Encrypted ${todosEncrypted} todo(s) and ${categoriesEncrypted} category(ies).`
                        if (errors > 0) {
                            message += ` ${errors} error(s) occurred.`
                            this.migrateStatus.style.color = '#f90'
                        } else {
                            this.migrateStatus.style.color = '#3c3'
                        }
                        this.migrateStatus.textContent = message
                    }
                } catch (e) {
                    console.error('Migration error:', e)
                    this.migrateStatus.textContent = 'Error: ' + e.message
                    this.migrateStatus.style.color = '#c33'
                } finally {
                    this.migrateDataBtn.disabled = false
                    this.migrateDataBtn.textContent = 'Encrypt Existing Data'
                    this.migrateStatus.style.display = 'block'
                }
            }
        }

        // Initialize the app
        new TodoApp()
    </script>
</body>
</html>
